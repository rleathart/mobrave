<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>MOBRave</title>
  </head>

  <script src="/executor.js"></script>
  <script src="/rnbo.min.js"></script>

  <body>
    <h1>Hello, MOBRave</h1>

    <div>
      <input type="range" id="freqSlider" min="20" max="1000" value="110">
      <label for="freqSlider">Frequency</label>
    </div>

    <button id="playButton" onclick="toggleAudio()">
      Play
    </button>

    <div id="metrics">
      <table id="metrics.table" border="1" cellpadding="8" cellspacing="0">
        <thead>
          <tr>
            <th>Counter</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="metrics.table.tbody">
        </tbody>
      </table>
    </div>

    <div id="console">
      <span id="console.header">Console</span>
      <pre id="console.output"></pre>
    <div>
  </body>

  <script type="text/javascript">

    let logFunction = console.log;
    let errFunction = console.error;
    let maxConsoleLen = 64 * 1024; // 64 KiB limit
    let consoleOutput = document.getElementById('console.output');
    let osc;

    let device;

    console.log = function(message) {
      if (consoleOutput.innerHTML.length > maxConsoleLen)
        consoleOutput.innerHTML = "";

      consoleOutput.innerHTML += message + '<br>';
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      logFunction(message);
    };

    console.error = function(message) {
      if (consoleOutput.innerHTML.length > maxConsoleLen)
       consoleOutput.innerHTML = "";

      consoleOutput.innerHTML += message + '<br>';
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      errFunction(message);
    };

    console.log('Hello script!')

    let freqSlider = document.getElementById('freqSlider');
    freqSlider.addEventListener('input', () => {
      if (osc) {
        osc.frequency.value = freqSlider.value;
      }

      if (device) {
        let e = new RNBO.MessageEvent(RNBO.TimeNow, "freq", Number(freqSlider.value));
        device.scheduleEvent(e);
      }
    })

    let mobrave;
    let m = MOBRave;
    let patcher;
    let currentLatents = [];

    (async () => {
      console.log('Fetching RNBO patch')
      let rawPatcher = await fetch('/patch.export.json')
      patcher = await rawPatcher.json();

      console.log('Loading wasm module');
      mobrave = await MOBRave();

      let res = await fetch('/weights.bin');
      let buffer = await res.arrayBuffer();

      let updateLatents = function(data, count) {
        let f32data = new Float32Array(mobrave.HEAPF32.buffer, data, count);

        // NOTE(robin): send latents to RNBO
        let latents = Array.from(f32data);
        if (device) {
          let e = new RNBO.MessageEvent(RNBO.TimeNow, "latents_in", latents);
          device.scheduleEvent(e);
        }

        // NOTE(robin): update the latents with the most recent values we got from RNBO
        for (let i = 0; i < currentLatents.length; i++) {
          if (i < count)
            f32data[i] = currentLatents[i];
        }
      };

      let blockSize = 2048;
      let numLatents = 4;
      mobrave.setLatentsCallback(updateLatents);
      mobrave.setCurrentModel(buffer, blockSize, numLatents);

      function updateMetrics() {
        let decodeTime = document.getElementById('metrics.decodeTime');
        let updateLatentsTime = document.getElementById('metrics.updateLatentsTime');

        let metrics = mobrave.getMetrics();

        let tbody = "";
        for (field in metrics) {
          value = Number(metrics[field]).toFixed(2);
          tbody += `<tr><td style="text-align: right;">${field}</td><td>${value}</td></tr>\n`;
        }

        let e = document.getElementById('metrics.table.tbody');
        e.innerHTML = tbody;
      }

      let metricUpdateIntervalMs = 33;
      setInterval(updateMetrics, metricUpdateIntervalMs);
    })()

    let playButton = document.getElementById('playButton');
    let audioContext;
    let oscillator;

    let rnboInitTask;
    async function onProcessorCreated() {
      console.log('onProcessorCreated');

      clearTimeout(rnboInitTask);
      rnboInitTask = setTimeout(async () => {
        if (audioContext === undefined)
          return;

        device = await RNBO.createDevice({context: audioContext, patcher: patcher });

        device.messageEvent.subscribe((ev) => {
          if (ev.tag === "latents_out") {
            currentLatents = ev.payload;
          }
        });

        oscillator.connect(audioContext.mobraveWorklet);
        audioContext.mobraveWorklet.connect(device.node);
        device.node.connect(audioContext.destination);
      }, 100);

      console.log(`mobraveWorklet: ${audioContext.mobraveWorklet}`);
    }

    async function toggleAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 110;
        oscillator.start();
        osc = oscillator;

        let cppContext = mobrave.emscriptenRegisterAudioObject(audioContext);
        mobrave.createWasmAudioThread(cppContext);

        playButton.innerHTML = 'Pause';
      } else {
        clearTimeout(rnboInitTask);
        audioContext.close();
        audioContext = undefined;
        playButton.innerHTML = 'Play';
      }
    }
  </script>

</html>
