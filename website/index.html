<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOBRave</title>
  </head>

  <script src="/executor.js"></script>
  <script src="/rnbo.min.js"></script>

  <body>
    <h1>Hello, MOBRave</h1>

    <div>
      <input type="range" id="freqSlider" min="20" max="1000" value="110">
      <label for="freqSlider">Frequency</label>
    </div>

    <button id="playButton" onclick="toggleAudio()">
      Play
    </button>

    <div id="console-output"></div>
  </body>

  <script type="text/javascript">
    let logFunction = console.log;
    let errFunction = console.error;
    let maxConsoleLen = 2048;
    let consoleOutput = document.getElementById('console-output');
    let osc;

    let device;

    console.log = function(message) {
      if (consoleOutput.innerHTML.length > maxConsoleLen)
        consoleOutput.innerHTML = "";

      consoleOutput.innerHTML += message + '<br>';
      logFunction(message);
    };

    console.error = function(message) {
      if (consoleOutput.innerHTML.length > maxConsoleLen)
        consoleOutput.innerHTML = "";

      consoleOutput.innerHTML += message + '<br>';
      errFunction(message);
    };

    console.log('Hello script!')

    let freqSlider = document.getElementById('freqSlider');
    freqSlider.addEventListener('input', () => {
      if (osc) {
        osc.frequency.value = freqSlider.value;
      }

      if (device) {
        let e = new RNBO.MessageEvent(RNBO.TimeNow, "freq", Number(freqSlider.value));
        device.scheduleEvent(e);
      }
    })

    let mobrave;
    let m = MOBRave;
    let patcher;
    let currentLatents = [];

    (async () => {
      console.log('Fetching RNBO patch')
      let rawPatcher = await fetch('/patch.export.json')
      patcher = await rawPatcher.json();

      console.log('Loading wasm module');
      mobrave = await MOBRave();

      let res = await fetch('/weights.bin');
      let buffer = await res.arrayBuffer();

      let updateLatents = function(data, count) {
        let f32data = new Float32Array(mobrave.HEAPF32.buffer, data, count);

        // NOTE(robin): send latents to RNBO
        let latents = Array.from(f32data);
        let e = new RNBO.MessageEvent(RNBO.TimeNow, "latents_in", latents);
        device.scheduleEvent(e);

        // NOTE(robin): update the latents with the most recent values we got from RNBO
        for (let i = 0; i < currentLatents.length; i++) {
          if (i < count)
            f32data[i] = currentLatents[i];
        }
      };

      let blockSize = 2048;
      let numLatents = 4;
      mobrave.setLatentsCallback(updateLatents);
      mobrave.setCurrentModel(buffer, blockSize, numLatents);
    })()

    let playButton = document.getElementById('playButton');
    let audioContext;
    let oscillator;

    async function onProcessorCreated() {
      console.log('onProcessorCreated');

      oscillator.connect(audioContext.mobraveWorklet);
      device.node.connect(audioContext.destination);
    }

    async function toggleAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        device = await RNBO.createDevice({context: audioContext, patcher: patcher });

        device.messageEvent.subscribe((ev) => {
          if (ev.tag === "latents_out") {
            currentLatents = ev.payload;
          }
        });

        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = 110;
        oscillator.start();
        osc = oscillator;

        let cppContext = mobrave.emscriptenRegisterAudioObject(audioContext);
        mobrave.createWasmAudioThread(cppContext);

        playButton.innerHTML = 'Pause';
      } else {
        audioContext.close();
        audioContext = undefined;
        playButton.innerHTML = 'Play';
      }
    }
  </script>

</html>
